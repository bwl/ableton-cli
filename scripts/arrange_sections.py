#!/usr/bin/env python3
"""Split 32-bar arrangements into 8 scene sections (4 bars each).

Creates 16-beat clips in scene rows 0-7, one per chord change,
and names each scene in the Master track.
"""

import sys
import time
from pathlib import Path

sys.path.insert(0, str(Path(__file__).resolve().parent.parent))
from lib import osc

SCENE_NAMES = [
    "Intro (Am)",
    "Opening (F)",
    "Build (C)",
    "Tension (G)",
    "Energy (Am)",
    "Peak (F)",
    "Climax (C)",
    "Resolution (G)",
]

# All note data: (pitch, start_beat, duration, velocity)
# Extracted from the 32-bar compositions, grouped by section

GUITAR_NOTES = {  # Track 5
    0: [(64,1,2,75),(62,3.5,1,70),(60,5,2.5,80),(57,8,1.5,75),(60,10,0.5,65),(62,10.5,0.5,65),(64,11,2.5,85),(60,14,1.5,75)],
    1: [(65,0.5,2,80),(69,3,1.5,85),(67,5,1,75),(65,6,2,80),(62,8.5,1,70),(60,10,1.5,80),(57,12,1,75),(60,13,0.5,65),(62,13.5,0.5,65),(65,14,1.5,80)],
    2: [(64,0,2,80),(67,2.5,1.5,85),(69,4.5,2,90),(67,7,1,80),(64,8.5,1.5,80),(60,10.5,2,85),(62,13,1,75),(64,14,1.5,80)],
    3: [(67,0.5,2,80),(64,3,1.5,75),(62,5,1,80),(59,6.5,2,85),(57,9,1,75),(60,10.5,0.5,70),(62,11,1,75),(64,12.5,1,80),(62,13.5,0.5,70),(60,14,1.5,80)],
    4: [(69,0,1.5,90),(72,2,1,95),(69,3.5,1,85),(67,5,0.5,80),(64,5.5,1.5,85),(62,7.5,1,80),(64,9,0.5,75),(67,9.5,0.5,80),(69,10,2,90),(67,12.5,1,80),(64,14,1.5,85)],
    5: [(65,0,1.5,90),(69,2,1,90),(72,3.5,2.5,100),(69,6.5,1,85),(67,8,0.5,80),(65,8.5,1.5,90),(62,10.5,1,80),(60,12,0.5,75),(62,12.5,0.5,75),(65,13,2,90),(69,15.5,0.5,80)],
    6: [(72,0,2.5,100),(74,3,1,100),(72,4.5,1,90),(69,6,1.5,85),(67,8,1,80),(64,9.5,1.5,85),(67,11.5,1,80),(69,12.5,0.5,80),(72,13,2,95),(69,15.5,0.5,80)],
    7: [(67,0,2,85),(69,2.5,1.5,90),(67,4.5,1,80),(64,6,1.5,80),(62,8,1,75),(60,9.5,0.5,70),(59,10,1,75),(57,11.5,1,80),(60,13,0.5,70),(57,13.5,2,85)],
}

BASS_NOTES = {  # Track 1
    0: [(45,0,3,90),(48,3.5,1,70),(45,5,2.5,85),(43,8,1.5,75),(45,10,2,80),(48,12.5,1,70),(45,14,1.5,80)],
    1: [(41,0,3,90),(45,3.5,1,70),(41,5,2.5,85),(43,8,1.5,75),(41,10,2,80),(45,12.5,1,70),(41,14,1.5,80)],
    2: [(48,0,3,90),(47,3.5,1,70),(48,5,2.5,85),(45,8,1.5,75),(48,10,2,80),(47,12.5,1,70),(48,14,1.5,80)],
    3: [(43,0,3,90),(45,3.5,1,70),(47,5,2.5,85),(43,8,1.5,75),(45,10,2,80),(43,12.5,1,70),(45,14,1.5,80)],
    4: [(45,0,1.5,95),(48,2,1,85),(45,3.5,1,80),(43,5,0.5,75),(45,5.5,1.5,90),(48,7.5,1,85),(45,9,1.5,90),(43,11,1,80),(45,12.5,1.5,85),(48,14,1.5,80)],
    5: [(41,0,1.5,95),(45,2,1,85),(48,3.5,1,80),(45,5,0.5,75),(41,5.5,1.5,90),(43,7.5,1,85),(45,9,1.5,90),(41,11,1,80),(43,12.5,1.5,85),(41,14,1.5,80)],
    6: [(48,0,1.5,100),(47,2,1,90),(48,3.5,1,85),(45,5,0.5,80),(48,5.5,1.5,95),(52,7.5,1,90),(48,9,1.5,95),(47,11,1,85),(48,12.5,1.5,90),(45,14,1.5,85)],
    7: [(43,0,1.5,90),(47,2,1,85),(45,3.5,1,80),(43,5,0.5,75),(45,5.5,1.5,85),(47,7.5,1,80),(45,9,1.5,85),(43,11,1,80),(45,12.5,1.5,85),(43,14,1.5,80)],
}

KEYS_NOTES = {  # Track 2 — chord voicings
    0: [(57,0,7,60),(60,0,7,55),(64,0,7,50),(57,8,7,65),(60,8,7,60),(64,8,7,55)],
    1: [(53,0,7,60),(57,0,7,55),(60,0,7,50),(53,8,7,65),(57,8,7,60),(60,8,7,55)],
    2: [(60,0,7,60),(64,0,7,55),(67,0,7,50),(60,8,7,65),(64,8,7,60),(67,8,7,55)],
    3: [(55,0,7,60),(59,0,7,55),(62,0,7,50),(55,8,7,65),(59,8,7,60),(62,8,7,55)],
    4: [(57,0,3,70),(60,0,3,65),(64,0,3,60),(57,4,2,65),(60,4,2,60),(57,7,4,75),(60,7,4,70),(64,7,4,65),(57,12,3,70),(60,12,3,65)],
    5: [(53,0,3,70),(57,0,3,65),(60,0,3,60),(53,4,2,65),(57,4,2,60),(53,7,4,75),(57,7,4,70),(60,7,4,65),(53,12,3,70),(57,12,3,65)],
    6: [(60,0,3,80),(64,0,3,75),(67,0,3,70),(60,4,2,75),(64,4,2,70),(60,7,4,85),(64,7,4,80),(67,7,4,75),(60,12,3,80),(64,12,3,75)],
    7: [(55,0,3,70),(59,0,3,65),(62,0,3,60),(55,4,2,65),(59,4,2,60),(55,7,4,70),(59,7,4,65),(62,7,4,60),(55,12,3,65),(59,12,3,60),(62,12,3,55)],
}

PAD_NOTES = {  # Track 4 — long washes (one chord per section)
    0: [(57,0,15,50),(64,0,15,45)],
    1: [(53,0,15,50),(60,0,15,45)],
    2: [(60,0,15,50),(67,0,15,45)],
    3: [(55,0,15,50),(62,0,15,45)],
    4: [(57,0,15,60),(64,0,15,55)],
    5: [(53,0,15,60),(60,0,15,55)],
    6: [(60,0,15,65),(67,0,15,60)],
    7: [(55,0,15,55),(62,0,15,50)],
}

LEAD_NOTES = {  # Track 3 — counter-melody
    0: [(69,3,0.5,60),(67,4,0.75,55),(72,7,0.75,65),(69,9,0.75,55),(67,13,0.75,60)],
    1: [(72,2,0.75,65),(69,4,0.75,55),(67,5,0.5,50),(64,7.5,0.75,60),(67,9,0.75,55),(69,11.5,0.5,60),(72,12,0.75,65),(67,15,0.75,55)],
    2: [(69,2,0.5,65),(72,3,0.5,60),(74,4,0.75,70),(72,6,0.75,60),(69,7.5,0.75,55),(67,9.5,0.75,60),(64,11,0.75,55),(67,13.5,0.5,55),(69,14.5,0.75,60)],
    3: [(72,0,0.75,65),(69,2,0.75,55),(64,4,0.75,60),(67,6,0.5,55),(69,8,0.75,60),(72,9,0.5,65),(69,10,0.75,55),(64,13,0.75,55),(62,15,0.75,50)],
    4: [(76,1.5,0.75,70),(74,2.5,0.5,65),(72,4,0.75,60),(74,6.5,0.5,65),(76,7,0.75,70),(74,8.5,0.5,65),(72,11,0.5,60),(69,11.5,0.75,55),(67,13,0.75,55),(72,15,0.75,65)],
    5: [(76,1,0.75,70),(74,2,0.5,65),(69,5,0.75,60),(72,6,0.75,70),(76,8,0.5,65),(74,9,0.75,70),(72,10,0.5,60),(69,11.5,0.75,60),(72,13,0.5,65),(74,14,0.75,70)],
    6: [(69,1.5,0.5,70),(67,2.5,0.75,65),(72,4,0.5,70),(74,5,0.75,75),(76,7,0.5,70),(74,8.5,0.5,65),(72,9,0.75,70),(69,11,0.75,65),(72,12,0.5,70),(74,13.5,0.5,75),(72,15,0.75,65)],
    7: [(69,1,0.75,65),(67,2,0.75,60),(72,4,0.75,60),(69,5.5,0.75,55),(67,7.5,0.75,50),(64,9,0.75,50),(62,11,0.75,45),(60,12.5,1.5,50),(57,14.5,1,45)],
}

# Drums: kick=36, snare=38, hat=42, open hat=46, ride=51, crash=49, toms=43,45,47
DRUMS_NOTES = {  # Track 0
    0: [  # Sparse intro — quarter hats
        (36,0,0.5,95),(42,0,0.25,50),(38,1,0.5,80),(42,1,0.25,50),(42,2,0.25,50),(36,2.5,0.5,70),(42,3,0.25,50),(38,3,0.5,80),
        (36,4,0.5,95),(42,4,0.25,50),(38,5,0.5,80),(42,5,0.25,50),(42,6,0.25,50),(36,6.5,0.5,70),(42,7,0.25,50),(38,7,0.5,85),
        (36,8,0.5,95),(42,8,0.25,50),(38,9,0.5,80),(42,9,0.25,50),(42,10,0.25,50),(36,10.5,0.5,75),(42,11,0.25,50),(38,11,0.5,80),
        (36,12,0.5,95),(42,12,0.25,50),(38,13,0.5,85),(42,13,0.25,50),(42,14,0.25,50),(36,14.5,0.5,70),(42,15,0.25,55),(38,15,0.5,90),
    ],
    1: [  # Opening — 8th hats, ghost snares
        (36,0,0.5,95),(42,0,0.25,55),(42,0.5,0.25,35),(38,1,0.5,85),(42,1,0.25,55),(42,1.5,0.25,35),(36,1.75,0.5,70),(42,2,0.25,55),(42,2.5,0.25,35),(38,2.5,0.25,35),(42,3,0.25,55),(38,3,0.5,85),(42,3.5,0.25,35),
        (36,4,0.5,95),(42,4,0.25,55),(42,4.5,0.25,35),(38,5,0.5,85),(42,5,0.25,55),(42,5.5,0.25,35),(36,5.75,0.5,75),(42,6,0.25,55),(46,6.5,0.5,55),(42,7,0.25,55),(38,7,0.5,90),(42,7.5,0.25,35),
        (36,8,0.5,95),(42,8,0.25,55),(42,8.5,0.25,35),(38,9,0.5,85),(42,9,0.25,55),(42,9.5,0.25,35),(36,9.75,0.5,70),(42,10,0.25,55),(42,10.5,0.25,35),(42,11,0.25,55),(38,11,0.5,85),(42,11.5,0.25,35),
        (36,12,0.5,95),(42,12,0.25,55),(42,12.5,0.25,35),(38,13,0.5,85),(42,13,0.25,55),(42,13.5,0.25,35),(36,13.75,0.5,80),(42,14,0.25,55),(46,14.5,0.5,55),(38,15,0.5,95),(36,15,0.5,85),(42,15.5,0.25,40),
    ],
    2: [  # Full groove — ghost snares, open hats
        (36,0,0.5,100),(42,0,0.25,60),(42,0.5,0.25,40),(38,1,0.5,90),(42,1,0.25,60),(42,1.5,0.25,40),(36,1.75,0.5,70),(42,2,0.25,60),(38,2.5,0.25,35),(42,2.5,0.25,40),(42,3,0.25,60),(38,3,0.5,90),(42,3.5,0.25,40),
        (36,4,0.5,100),(42,4,0.25,60),(42,4.5,0.25,40),(38,5,0.5,90),(42,5,0.25,60),(42,5.5,0.25,40),(36,5.75,0.5,75),(42,6,0.25,60),(46,6.5,0.5,60),(42,7,0.25,60),(38,7,0.5,90),(42,7.5,0.25,40),
        (36,8,0.5,100),(42,8,0.25,60),(42,8.5,0.25,40),(38,9,0.5,90),(42,9,0.25,60),(42,9.5,0.25,40),(36,9.75,0.5,70),(42,10,0.25,60),(42,10.5,0.25,40),(38,10.5,0.25,35),(42,11,0.25,60),(38,11,0.5,90),(42,11.5,0.25,40),
        (36,12,0.5,100),(42,12,0.25,60),(42,12.5,0.25,40),(38,13,0.5,85),(42,13,0.25,60),(42,13.5,0.25,40),(36,13.75,0.5,75),(42,14,0.25,60),(46,14.5,0.5,60),(38,15,0.5,95),(47,15,0.5,80),(42,15.5,0.25,45),
    ],
    3: [  # Building — ride cymbal, tom fill
        (36,0,0.5,100),(51,0,0.25,55),(51,0.5,0.25,40),(38,1,0.5,90),(51,1,0.25,55),(51,1.5,0.25,40),(36,1.75,0.5,75),(51,2,0.25,55),(38,2.5,0.25,35),(51,2.5,0.25,40),(51,3,0.25,55),(38,3,0.5,90),(51,3.5,0.25,40),
        (36,4,0.5,100),(51,4,0.25,55),(51,4.5,0.25,40),(38,5,0.5,90),(51,5,0.25,55),(51,5.5,0.25,40),(36,5.75,0.5,70),(51,6,0.25,55),(46,6.5,0.5,55),(51,7,0.25,55),(38,7,0.5,90),(51,7.5,0.25,40),
        (36,8,0.5,100),(51,8,0.25,55),(51,8.5,0.25,40),(38,9,0.5,90),(51,9,0.25,55),(51,9.5,0.25,40),(36,9.75,0.5,75),(51,10,0.25,55),(51,10.5,0.25,40),(38,10.5,0.25,35),(51,11,0.25,55),(38,11,0.5,90),(51,11.5,0.25,40),
        (36,12,0.5,100),(51,12,0.25,55),(51,12.5,0.25,40),(38,13,0.5,85),(51,13,0.25,55),(51,13.5,0.25,40),(47,14,0.5,85),(45,14.5,0.5,80),(43,15,0.5,85),(38,15.5,0.5,95),
    ],
    4: [  # Energy! Crash on 1
        (49,0,1,100),(36,0,0.5,100),(42,0,0.25,65),(42,0.5,0.25,40),(38,1,0.5,95),(42,1,0.25,65),(42,1.5,0.25,40),(36,1.75,0.5,80),(42,2,0.25,65),(36,2.5,0.5,70),(42,2.5,0.25,40),(42,3,0.25,65),(38,3,0.5,95),(42,3.5,0.25,40),
        (36,4,0.5,100),(42,4,0.25,65),(42,4.5,0.25,40),(38,5,0.5,95),(42,5,0.25,65),(42,5.5,0.25,40),(36,5.75,0.5,75),(42,6,0.25,65),(46,6.5,0.5,60),(42,7,0.25,65),(38,7,0.5,95),(42,7.5,0.25,40),
        (36,8,0.5,100),(42,8,0.25,65),(42,8.5,0.25,40),(38,9,0.5,95),(42,9,0.25,65),(42,9.5,0.25,40),(36,9.75,0.5,80),(42,10,0.25,65),(38,10.5,0.25,40),(42,10.5,0.25,40),(42,11,0.25,65),(38,11,0.5,95),(42,11.5,0.25,40),
        (36,12,0.5,100),(42,12,0.25,65),(42,12.5,0.25,40),(38,13,0.5,90),(42,13,0.25,65),(42,13.5,0.25,40),(36,13.75,0.5,75),(42,14,0.25,65),(46,14.5,0.5,60),(38,15,0.5,100),(36,15,0.5,85),(42,15.5,0.25,45),
    ],
    5: [  # Peak — crash, driving
        (49,0,1,95),(36,0,0.5,100),(42,0,0.25,65),(42,0.5,0.25,45),(38,1,0.5,95),(42,1,0.25,65),(42,1.5,0.25,45),(36,1.75,0.5,80),(42,2,0.25,65),(36,2.5,0.5,70),(42,2.5,0.25,45),(42,3,0.25,65),(38,3,0.5,95),(42,3.5,0.25,45),
        (36,4,0.5,100),(42,4,0.25,65),(42,4.5,0.25,45),(38,5,0.5,95),(42,5,0.25,65),(42,5.5,0.25,45),(36,5.75,0.5,80),(42,6,0.25,65),(46,6.5,0.5,65),(42,7,0.25,65),(38,7,0.5,95),(42,7.5,0.25,45),
        (36,8,0.5,100),(42,8,0.25,65),(42,8.5,0.25,45),(38,9,0.5,95),(42,9,0.25,65),(42,9.5,0.25,45),(36,9.75,0.5,80),(42,10,0.25,65),(38,10.5,0.25,40),(42,10.5,0.25,45),(42,11,0.25,65),(38,11,0.5,95),(42,11.5,0.25,45),
        (36,12,0.5,100),(42,12,0.25,65),(42,12.5,0.25,45),(38,13,0.5,95),(42,13,0.25,65),(42,13.5,0.25,45),(36,13.75,0.5,80),(42,14,0.25,65),(46,14.5,0.5,65),(47,15,0.5,90),(45,15.5,0.5,85),
    ],
    6: [  # Climax — crash, toms, max energy
        (49,0,1,100),(36,0,0.5,100),(42,0,0.25,70),(42,0.5,0.25,45),(38,1,0.5,100),(42,1,0.25,70),(42,1.5,0.25,45),(36,1.75,0.5,85),(42,2,0.25,70),(36,2.5,0.5,75),(42,2.5,0.25,45),(42,3,0.25,70),(38,3,0.5,100),(42,3.5,0.25,45),
        (36,4,0.5,100),(42,4,0.25,70),(42,4.5,0.25,45),(38,5,0.5,100),(42,5,0.25,70),(42,5.5,0.25,45),(36,5.75,0.5,80),(42,6,0.25,70),(46,6.5,0.5,70),(42,7,0.25,70),(38,7,0.5,100),(42,7.5,0.25,45),
        (36,8,0.5,100),(42,8,0.25,70),(42,8.5,0.25,45),(38,9,0.5,100),(42,9,0.25,70),(42,9.5,0.25,45),(36,9.75,0.5,85),(42,10,0.25,70),(38,10.5,0.25,45),(42,10.5,0.25,45),(42,11,0.25,70),(38,11,0.5,100),(42,11.5,0.25,45),
        (36,12,0.5,100),(42,12,0.25,70),(42,12.5,0.25,45),(38,13,0.5,95),(42,13,0.25,70),(42,13.5,0.25,45),(47,14,0.5,90),(45,14.5,0.5,85),(43,15,0.5,90),(38,15.5,0.5,100),
    ],
    7: [  # Resolution — pulling back
        (36,0,0.5,90),(42,0,0.25,50),(42,1,0.25,50),(38,1,0.5,80),(42,2,0.25,50),(36,2.5,0.5,65),(42,3,0.25,50),(38,3,0.5,80),
        (36,4,0.5,85),(42,4,0.25,50),(42,5,0.25,50),(38,5,0.5,75),(42,6,0.25,50),(36,6.5,0.5,60),(42,7,0.25,50),(38,7,0.5,75),
        (36,8,0.5,80),(42,8,0.25,45),(42,9,0.25,45),(38,9,0.5,70),(42,10,0.25,45),(42,11,0.25,45),(38,11,0.5,65),
        (36,12,0.5,70),(42,13,0.25,40),(38,13,0.5,60),(42,14,0.25,35),(36,15,0.5,55),
    ],
}

# Which tracks have note data and their slot 4 clips to stop
TRACKS = {
    0: ("Drums", DRUMS_NOTES),
    1: ("Bass", BASS_NOTES),
    2: ("Keys", KEYS_NOTES),
    3: ("Lead", LEAD_NOTES),
    4: ("Pad", PAD_NOTES),
    5: ("Guitar", GUITAR_NOTES),
}

CLIP_LENGTH = 16  # 4 bars × 4 beats


def main():
    print("Setting up 8 scene sections...")

    # Name all scenes
    for i, name in enumerate(SCENE_NAMES):
        osc.set_scene_name(i, name)
        print(f"  Scene {i}: {name}")
    time.sleep(0.3)

    # Delete old 32-bar clips in slot 4 (and guitar slot 0)
    print("Clearing old 32-bar clips...")
    for track in range(7):
        try:
            osc.delete_clip(track, 4)
        except Exception:
            pass
    try:
        osc.delete_clip(5, 0)  # Guitar's old 32-bar clip
    except Exception:
        pass
    time.sleep(0.5)

    # Create and populate section clips
    for section in range(8):
        print(f"\nSection {section}: {SCENE_NAMES[section]}")
        for track, (name, notes_data) in TRACKS.items():
            section_notes = notes_data.get(section, [])
            if not section_notes:
                continue

            # Create clip
            osc.create_clip(track, section, CLIP_LENGTH)
            time.sleep(0.05)

            # Add notes (pitch, start, dur, vel, mute=0)
            note_tuples = [(p, s, d, v, 0) for p, s, d, v in section_notes]
            osc.add_notes(track, section, note_tuples)

            # Name the clip
            clip_name = f"{name} {section+1}"
            osc.set_clip_name(track, section, clip_name)
            print(f"  Track {track} ({name}): {len(section_notes)} notes")
            time.sleep(0.05)

    # Perc track (6) — copy the 8-bar groove to each even scene pair
    # The groove loops, so we just reference the existing clip
    print("\n  Track 6 (Perc): using existing groove loop")

    print("\nDone! Fire scenes 0-7 to play each section.")
    print("Use 'fire-scene <n>' to jump between sections.")


if __name__ == "__main__":
    main()
